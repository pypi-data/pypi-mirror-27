apiVersion: config.istio.io/v1alpha2 
kind: RouteRule 
metadata:
  name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}-invocations
spec:
   destination: 
      name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}
   match:
#     source:
#       labels:
#         istio: ingress
     request:
       headers:
         uri:
           prefix: /invocations 
   precedence: 2
   route:
   # Note:  'tag' is used by PipelineAI, 'version' is used by Istio.
   #        for now, keep these together - and keep them the same value
   {% for idx in range(PIPELINE_MODEL_NUM_TAGS_AND_WEIGHTS) %}
   - labels:
       tag: {{ PIPELINE_MODEL_TAG_LIST[idx] }}
       version: {{ PIPELINE_MODEL_TAG_LIST[idx] }}
     weight: {{ PIPELINE_MODEL_WEIGHT_LIST[idx] }}
   {% endfor %}
---
apiVersion: config.istio.io/v1alpha2
kind: RouteRule
metadata:
  name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}-ping
spec:
  destination:
    name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME}}
  match:
#    source:
#      labels:
#        istio: ingress
    request:
      headers:
        uri:
          prefix: /ping
  precedence: 2 
  route:
  - weight: 100
---
apiVersion: config.istio.io/v1alpha2
kind: RouteRule
metadata:
  name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}-dashboard 
spec:
  destination:
    name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}
  match:
    source:
      labels:
        istio: ingress
    request:
      headers:
        uri:
          prefix: /dashboard/.*
  precedence: 2
  route:
  - weight: 100
---
apiVersion: config.istio.io/v1alpha2
kind: RouteRule
metadata:
  name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}-dashboardstream
spec:
  destination:
    name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}
  match:
    source:
      labels:
        istio: ingress
    request:
      headers:
        uri:
          prefix: /dashboard.stream
  precedence: 2
  route:
  - weight: 100
---
apiVersion: config.istio.io/v1alpha2
kind: RouteRule
metadata:
  name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}-prometheus 
spec:
  destination:
    name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}
  match:
    source:
      labels:
        istio: ingress
    request:
      headers:
        uri:
          prefix: /prometheus/.*
  precedence: 2
  route:
  - weight: 100
---
apiVersion: config.istio.io/v1alpha2
kind: RouteRule
metadata:
  name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}-metrics 
spec:
  destination:
    name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}
  match:
    source:
      labels:
        istio: ingress
    request:
      headers:
        uri:
          prefix: /metrics/.*
  precedence: 2
  route:
  - weight: 100
---
apiVersion: config.istio.io/v1alpha2
kind: RouteRule
metadata:
  name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}-denyall
spec:
  destination:
    name: {{ PIPELINE_IMAGE_REGISTRY_NAMESPACE }}-{{ PIPELINE_MODEL_NAME }}
  match:
    source:
      labels:
        istio: ingress
    request:
      headers:
        uri:
          prefix: /.*
  precedence: 1
  route:
  - weight: 100
  httpFault:
    abort:
      percent: 100
      httpStatus: 403 # Forbidden for all URLs except those specified at a higher precedence (>1)
