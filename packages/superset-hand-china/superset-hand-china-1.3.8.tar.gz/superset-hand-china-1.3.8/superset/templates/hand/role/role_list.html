{% extends "superset/base.html" %} {% block body %} {% block navbar %} {% if not standalone_mode %}
<header class="top" role="header">
	{% if showHeader == undefined or showHeader == 'true'%} {% include 'appbuilder/navbar.html' %} {% endif %}
</header>
{% endif %} {% endblock %}
<script src="/static/assets/resources/role/js/jquery-2.1.1.min.js" type="text/javascript"></script>
<script src="/static/assets/resources/role/js/layer/layer.js" type="text/javascript"></script>
<script src="/static/assets/resources/role/js/jquery.tablednd.js" type="text/javascript"></script>
<script src="/static/assets/resources/role/js/jeeplus.js" type="text/javascript"></script>
<script src="/static/assets/resources/role/js/icheck.min.js" type="text/javascript"></script>
<script src="/static/assets/resources/role/js/icheck.js" type="text/javascript"></script>
<script src="/static/assets/resources/role/js/custom.min.js" type="text/javascript"></script>
<script src="/static/assets/resources/role/js/jquery.jBox-2.3.min.js" type="text/javascript"></script>


<!--<link rel="stylesheet" type="text/css" href="/static/assets/role/css/bootstrap.min.css" />-->
<link rel="stylesheet" type="text/css" href="/static/assets/node_modules/font-awesome/css/font-awesome.min.css" />
<link rel="stylesheet" type="text/css" href="/static/assets/resources/role/css/style.css">
<link rel="stylesheet" type="text/css" href="/static/assets/resources/role/css/custom.css">
<link rel="stylesheet" type="text/css" href="/static/assets/resources/role/css/layim.css">
<link rel="stylesheet" type="text/css" href="/static/assets/resources/role/css/jbox.min.css">
<link rel="stylesheet" type="text/css" href="/static/assets/resources/role/css/skins/all.css">

<script type="text/javascript">top.$.jBox.closeTip();</script>
<script type="text/javascript">
	$(document).ready(function () {
		// $('#contentTable thead tr th input.i-checks').on('ifChecked', function (event) { //ifCreated 事件应该在插件初始化之前绑定 
		// 	$('#contentTable tbody tr td input.i-checks').iCheck('check');
		// });

		// $('#contentTable thead tr th input.i-checks').on('ifUnchecked', function (event) { //ifCreated 事件应该在插件初始化之前绑定 
		// 	$('#contentTable tbody tr td input.i-checks').iCheck('uncheck');
		// });
		initRole();
	});
	function initRole() {
		$.ajax({
			type: 'get',
			url: '/hand/roles/list',
			success: function (data) {
				var roles = JSON.parse(data);
				roles.forEach(function (role, index) {
					appendRow(role)
				});
				initIcheck();
			},
			error: function () {
				alert("error");
			}
		});
	}

	function initIcheck() {
		$('.i-checks').icheck({
			checkboxClass: 'icheckbox_square-green',
			radioClass: 'iradio_square-green',
		});

	}
	function checkAll() {
		var checkAll = $('#checkAll');
		var checkboxes = $('input.i-checks');
		checkAll.on('ifChecked ifUnchecked', function (event) {
			if (event.type == 'ifChecked') {
				checkboxes.icheck('checked');
			} else {
				checkboxes.icheck('unchecked');
			}
		});
		checkboxes.on('ifChanged', function (event) {
			if (checkboxes.filter(':checked').length == checkboxes.length) {
				checkAll.prop('checked', 'checked');
			} else {
				checkAll.removeProp('checked');
			}
			checkAll.icheck('update');
		});
	}

	function appendRow(role) {
		if (role.name === 'Admin') {
			$('#contentTable tbody').append('<tr>' +
				'<td>' +
				'<div class="icheckbox_square-green" style="position: relative;"><input type="checkbox" id="Admin" class="i-checks" style="position: absolute; opacity: 0;">' +
				'</div>' +
				'</td>' +
				'<td>' +
				'<a href="#" onclick="openDialogView(&#39;{{ _("View Role") }}&#39;, &#39;/hand/roles/shows/' + role.id + '&#39;,&#39;800px&#39;, &#39;500px&#39;)">' + role.name + '</a>' +
				'</td>' +
				'<td>' +
				'<a href="#" onclick="openDialogView(&#39;{{ _("View Role") }}&#39;, &#39;/hand/roles/shows/' + role.id + '&#39;,&#39;800px&#39;, &#39;500px&#39;)" class="btn btn-info btn-xs"><i class="fa fa-search-plus"></i>{{ _(" View") }}</a>' +

				'</td>' + '</tr>')
		} else {
			$('#contentTable tbody').append('<tr>' +
				'<td>' +
				'<div class="icheckbox_square-green" style="position: relative;"><input type="checkbox" id="' + role.id + '" class="i-checks" style="position: absolute; opacity: 0;">' +
				'</div>' +
				'</td>' +
				'<td>' +
				'<a href="#" onclick="openDialogView(&#39;{{ _("View Role") }}&#39;, &#39;/hand/roles/shows/' + role.id + '&#39;,&#39;800px&#39;, &#39;500px&#39;)">' + role.name + '</a>' +
				'</td>' +
				'<td>' +
				'<a href="#" onclick="openDialogView(&#39;{{ _("View Role") }}&#39;, &#39;/hand/roles/shows/' + role.id + '&#39;,&#39;800px&#39;, &#39;500px&#39;)" class="btn btn-info btn-xs"><i class="fa fa-search-plus"></i>{{ _(" View") }}</a>' +

				'<a href="#" onclick="openDialog(&#39;{{ _("Change Role") }}&#39;, &#39;/hand/roles/preEdit/' + role.id + '&#39;,&#39;800px&#39;, &#39;500px&#39;)" class="btn btn-success btn-xs"><i class="fa fa-edit"></i>{{ _(" Change") }}</a>' +

				'<a href="/roles/delete/' + role.id + '" onclick="return confirmx(&#39;{{ _("Are you sure delete the role?") }}&#39;, this.href)" class="btn btn-danger btn-xs"><i class="fa fa-trash"></i>{{ _(" Delete") }}</a>' +

				'<a href="#" onclick="openDialog(&#39;{{ _("Menu Permissions") }}&#39;, &#39;/hand/roles/grant/menu/' + role.id + '&#39;,&#39;350px&#39;, &#39;500px&#39;)" class="btn btn-primary btn-xs"><i class="fa fa-edit"></i>{{ _(" Menu Permissions") }}</a>' +

				'<a href="#" onclick="openDialog(&#39;{{ _("Data Permissions") }}&#39;, &#39;/hand/roles/grant/data/' + role.id + '&#39;,&#39;350px&#39;, &#39;500px&#39;)" class="btn btn-warning btn-xs"><i class="fa fa-edit"></i>{{ _(" Data Permissions") }}</a>' +


				'</td>' + '</tr>');
		}
	}

	function edit() {

		var size = $("#contentTable tbody tr td input.i-checks:checked").size();
		if (size == 0) {
			top.layer.alert('请至少选择一条数据!', { icon: 0, title: '警告' });
			return;
		}

		if (size > 1) {
			top.layer.alert('只能选择一条数据!', { icon: 0, title: '警告' });
			return;
		}
		var id = $("#contentTable tbody tr td input.i-checks:checkbox:checked").attr("id");
		openDialog("修改" + '角色', "/hand/roles/preEdit/" + id, "800px", "500px", "");
	}
</script>
<!-- 编辑按钮 -->



<script type="text/javascript">
	function appenThead() {
		$('#contentTable thead').append(
			'<tr> <th> <div class="icheckbox_square-green" style="position: relative;">' +
			'<input onclick="checkAll()" id="checkAll" type="checkbox" class="i-checks"' +
			'style="position: absolute; opacity: 0;"> </div> </th> <th>{{ _("Role Name") }}</th> <th>{{ _("Action") }}</th></tr>'
		)
	}
</script>
<script type="text/javascript">
	function sortOrRefresh() {
		$('#contentTable thead').empty();
		appenThead();
		$('#contentTable tbody').empty();
		initRole();
	}
</script>

<script type="text/javascript">
	function add() {
		openDialog("新增" + '角色', "/hand/roles/preAdd", "800px", "500px", "");
	}
</script>

<!-- 增加按钮 -->
<script type="text/javascript">
	function deleteAll() {

		var str = "";
		var containAdmin = false;
		var ids = [];
		$("#contentTable tbody tr td input.i-checks:checkbox").each(function () {
			if (true == $(this).is(':checked')) {
				if ($(this).attr('id') === 'Admin') {
					containAdmin = true;
					ids = [];
					return false; // equals continue;
				}
				ids.push($(this).attr("id"))
			}
		});

		if (containAdmin) {
			top.layer.alert('Admin权限不允许修改!', { icon: 0, title: '警告' });
			return;
		}

		if (ids == "" && !containAdmin) {
			top.layer.alert('请至少选择一条数据!', { icon: 0, title: '警告' });
			return;
		}
		top.layer.confirm('确认要彻底删除数据吗?', { icon: 3, title: '系统提示' }, function (index) {
			var rowids = [];
			ids.forEach(function (id, index) {
				rowids.push(id)
			})
			$.ajax({
				type: 'POST',
				data: { 'action': 'muldelete', 'rowid': rowids },
				url: '/roles/action_post',
				// url: '/superset/roles/muldelete',
				// dataType: 'json',
				traditional: true,
				success: function (data) {
					sortOrRefresh();
				},
				error: function (xhr) {
					alert("error")
				}
			});
			top.layer.close(index);
		});


	}

</script>
<!-- 删除按钮 -->


<!--<form id="inputForm">-->
<div class="ibox-content">
	<div class="row" style="margin-bottom: 10px">
<div class="col-sm-12">
	<div class="pull-left">
		<button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="left" onclick="add()" title={{ _("Add") }}><i class="fa fa-plus"></i>{{ _(" Add") }}</button>



<button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="left" onclick="edit()" title={{ _("Change") }}><i class="fa fa-file-text-o"></i>{{ _(" Change") }}</button>




<button class="btn btn-white btn-sm" onclick="deleteAll()" data-toggle="tooltip" data-placement="left" title={{ _("Delete") }}><i class="fa fa-trash-o"> </i>{{ _(" Delete") }}</button>



<button class="btn btn-white btn-sm " data-toggle="tooltip" data-placement="left" onclick="sortOrRefresh()" title={{ _("Refresh") }}><i class="glyphicon glyphicon-repeat"></i>{{ _(" Refresh") }}</button>

</div>
</div>
</div>

<table id="contentTable" class="table table-striped table-bordered table-hover table-condensed dataTables-example dataTable">
	<thead>
		<tr>
			<th>
				<div class="icheckbox_square-green" style="position: relative;"><input onclick="checkAll()" id="checkAll" type="checkbox" class="i-checks" style="position: absolute; opacity: 0;">
</div>
</th>
<th>{{ _("Role Name") }}</th>
<th>{{ _("Action") }}</th>
</tr>
</thead>
<tbody>

</tbody>
</table>
</div>
</div>
</div>
<!--</form>-->
<div id='roles-data' roles-data="{{d}}"></div>
{% endblock %}
<!--<script src="/static/assets/role/js/icheck-init.js" type="text/javascript"></script>-->